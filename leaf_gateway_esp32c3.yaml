substitutions:
  devicename: kc868_leaf

esphome:
  name: ${devicename}
  friendly_name: "Leaf OBD Gateway (KC868)"

esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: arduino

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "${devicename}_fallback"
    password: "changeme123"
  power_save_mode: none

api:

ota:
  platform: esphome

# Включаем встроенный web-сервр для отладки
web_server:
  port: 80
  local: true

external_components:
  - source:
      type: git
      url: https://github.com/lazyzero/ESPhome_Nissan_Leaf
      ref: main
    components:
      - leaf_obd_uart

uart:
  - id: uart_obd
    tx_pin: GPIO7  # UART TX
    rx_pin: GPIO6  # UART RX
    baud_rate: 38400  #HC-05/ELM327

logger:
  level: DEBUG
  baud_rate: 115200       # logging USB
  logs:
    leaf_obd_uart: DEBUG

leaf_obd_uart:
  id: leaf_obd
  uart_id: uart_obd
  update_interval: 60s
  soc:
    name: "Leaf Battery SOC"
    unit_of_measurement: "%"
    icon: "mdi:battery"
    accuracy_decimals: 1
    device_class: battery
  hv:
    name: "Leaf HV Voltage"
    unit_of_measurement: "V"
    icon: "mdi:flash"
    accuracy_decimals: 2
    device_class: voltage
  soh:
    name: "Leaf Battery SOH"
    unit_of_measurement: "%"
    icon: "mdi:battery-heart"
    accuracy_decimals: 1
    device_class: battery
  ahr:
    name: "Leaf Battery AHr"
    unit_of_measurement: "Ah"
    icon: "mdi:battery-heart"
    accuracy_decimals: 2
    device_class: battery
  odometer:
    name: "Leaf Odometer"
    unit_of_measurement: "km"
    icon: "mdi:counter"
    accuracy_decimals: 0
    device_class: distance
  bat_12v_voltage:
    name: "Leaf Battery 12V voltage"
  bat_12v_current:
    name: "Leaf Battery 12V current"
  quick_charges:
    name: "Leaf Battery QC"
  l1_l2_charges:
    name: "Leaf Battery L1/L2"
  ambient_temp:
    name: "Leaf Ambient temperature"
  estimated_ac_power:
    name: "Leaf estimated AC power"
  aux_power:
    name: "Leaf estimated AUX power"
  ac_power:
    name: "Leaf AC power"
  battery_temp_1:
    name: "Leaf Battery temperature1"
  battery_temp_2:
    name: "Leaf Battery temperature2"
  battery_temp_3:
    name: "Leaf Battery temperature3"
  battery_temp_4:
    name: "Leaf Battery temperature4"
  power_switch:
    name: "Leaf Power switch"
  plug_state:
    name: "Leaf Plug state"
  charge_mode:
    name: "Leaf Charge mode"
  atrv:
    name: "ELM327 Voltage"
    accuracy_decimals: 1

sensor:
  - platform: uptime
    name: "Uptime Sensor"
  - platform: homeassistant
    entity_id: sensor.outdoor_temperature
    id: ext_temp
    internal: true